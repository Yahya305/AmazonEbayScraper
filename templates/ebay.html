<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>eBay Scraper</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-100 flex justify-center items-center min-h-screen">
        <div
            class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-5xl text-center"
        >
            <h1 class="text-3xl font-bold mb-4 text-blue-600">
                üõí eBay Scraper
            </h1>
            <p class="text-gray-600 mb-6">
                Paste your eBay product links below (one link per line):
            </p>

            <textarea
                id="urlInput"
                placeholder="https://www.ebay.com/itm/...."
                class="w-full h-[350px] border border-gray-300 rounded-lg p-3 text-sm resize-y mb-4 focus:ring-2 focus:ring-blue-400"
            ></textarea>

            <div class="flex gap-3 justify-center mb-4">
                <button
                    id="scrapeBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg shadow"
                >
                    üöÄ Start Scraping
                </button>
                <button
                    id="downloadBtn"
                    class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg shadow hidden"
                >
                    ‚¨áÔ∏è Download CSV
                </button>
                <a
                    href="/"
                    class="inline-flex items-center px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-50"
                    >‚Üê Home</a
                >
            </div>

            <div id="status" class="mt-2 text-gray-700 font-medium"></div>
            <div
                id="results"
                class="mt-6 overflow-x-auto max-h-[400px] overflow-y-auto"
            ></div>
        </div>

        <script>
            let latestResults = [];

            document
                .getElementById("scrapeBtn")
                .addEventListener("click", async () => {
                    const textarea = document.getElementById("urlInput");
                    const status = document.getElementById("status");
                    const resultsDiv = document.getElementById("results");
                    const downloadBtn = document.getElementById("downloadBtn");
                    const scrapeBtn = document.getElementById("scrapeBtn");

                    resultsDiv.innerHTML = "";
                    downloadBtn.classList.add("hidden");
                    latestResults = [];

                    const urls = textarea.value
                        .split("\n")
                        .map((u) => u.trim())
                        .filter((u) => u);

                    if (!urls.length) {
                        alert("Please enter at least one eBay URL.");
                        status.textContent = "";
                        return;
                    }

                    // Disable button during scraping
                    scrapeBtn.disabled = true;
                    scrapeBtn.classList.add("opacity-50", "cursor-not-allowed");

                    // Create progress bar
                    status.innerHTML = `
                <div class="w-full bg-gray-200 rounded-full h-6 mb-2">
                    <div id="progressBar" class="bg-blue-600 h-6 rounded-full transition-all duration-300 flex items-center justify-center text-white text-xs font-bold" style="width: 0%">
                        0%
                    </div>
                </div>
                <p id="progressText" class="text-sm text-gray-600">Starting...</p>
            `;

                    try {
                        const response = await fetch("/scrape-ebay-stream", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ urls }),
                        });

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();

                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;

                            const chunk = decoder.decode(value);
                            const lines = chunk.split("\n\n");

                            for (const line of lines) {
                                if (line.startsWith("data: ")) {
                                    const jsonData = JSON.parse(
                                        line.substring(6)
                                    );
                                    handleSSEMessage(jsonData);
                                }
                            }
                        }
                    } catch (err) {
                        console.error(err);
                        status.innerHTML = "‚ùå Failed to connect to backend.";
                    } finally {
                        scrapeBtn.disabled = false;
                        scrapeBtn.classList.remove(
                            "opacity-50",
                            "cursor-not-allowed"
                        );
                    }
                });

            function handleSSEMessage(data) {
                const progressBar = document.getElementById("progressBar");
                const progressText = document.getElementById("progressText");
                const status = document.getElementById("status");
                const resultsDiv = document.getElementById("results");
                const downloadBtn = document.getElementById("downloadBtn");

                if (data.type === "progress") {
                    // Update progress bar
                    const percentage = data.percentage;
                    if (progressBar) {
                        progressBar.style.width = percentage + "%";
                        progressBar.textContent = Math.round(percentage) + "%";
                    }
                    if (progressText) {
                        progressText.textContent = `Scraping ${data.current} of ${data.total}: ${data.url}`;
                    }
                } else if (data.type === "item_success") {
                    // Add successful result to array
                    latestResults.push(data.data);
                    renderResults(latestResults);
                } else if (data.type === "item_failed") {
                    console.warn(`Failed to scrape: ${data.url}`, data.error);
                } else if (data.type === "complete") {
                    // Final results
                    latestResults = data.results;
                    status.innerHTML = `
                <div class="bg-green-100 border border-green-400 rounded-lg p-3 mt-4">
                    ‚úÖ Scraped <strong>${
                        data.successfulScrapes
                    }</strong> of <strong>${
                        data.totalUrls
                    }</strong> successfully.
                    ${
                        data.failedScrapes > 0
                            ? `<br>‚ùå <strong>${data.failedScrapes}</strong> failed.`
                            : ""
                    }
                </div>
            `;

                    if (latestResults.length > 0) {
                        downloadBtn.classList.remove("hidden");
                    }
                }
            }

            document
                .getElementById("downloadBtn")
                .addEventListener("click", () => {
                    if (!latestResults.length)
                        return alert("No results to download.");

                    const textarea = document.getElementById("urlInput");
                    const allUrls = textarea.value
                        .split("\n")
                        .map((u) => u.trim())
                        .filter((u) => u);

                    const successfulUrls = latestResults.map((r) => r.url);
                    const failedUrls = allUrls.filter(
                        (u) => !successfulUrls.includes(u)
                    );

                    const headers = Object.keys(latestResults[0]);
                    const rows = latestResults.map((obj) =>
                        headers
                            .map((h) => JSON.stringify(obj[h] ?? ""))
                            .join(",")
                    );

                    let csvContent = [
                        "Successful Scrapes",
                        headers.join(","),
                        ...rows,
                    ].join("\n");

                    if (failedUrls.length) {
                        csvContent +=
                            "\n\nFailed URLs\nURL\n" + failedUrls.join("\n");
                    }

                    const blob = new Blob([csvContent], {
                        type: "text/csv;charset=utf-8;",
                    });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = "ebay_results.csv";
                    link.click();
                });

            function renderResults(results) {
                const resultsDiv = document.getElementById("results");
                if (!results || !results.length) {
                    resultsDiv.innerHTML =
                        "<p class='text-gray-500'>No results found.</p>";
                    return;
                }

                const table = document.createElement("table");
                table.className =
                    "w-full border border-gray-300 text-left text-sm";
                table.innerHTML = `
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-3 py-2">Item #</th>
          <th class="border px-3 py-2">Title</th>
          <th class="border px-3 py-2">Price</th>
          <th class="border px-3 py-2">Stock</th>
          <th class="border px-3 py-2">Link</th>
        </tr>
      </thead>
      <tbody>
        ${results
            .map(
                (r) => `
            <tr class="hover:bg-gray-50">
              <td class="border px-3 py-2">${r.itemNumber || "-"}</td>
              <td class="border px-3 py-2">${r.title || "-"}</td>
              <td class="border px-3 py-2">${r.price ?? "-"}</td>
              <td class="border px-3 py-2">${r.stockCount ?? "-"}</td>
              <td class="border px-3 py-2">
                <a href="${
                    r.url
                }" target="_blank" class="text-blue-600 hover:underline">Open</a>
              </td>
            </tr>`
            )
            .join("")}
      </tbody>
    `;
                resultsDiv.innerHTML = "";
                resultsDiv.appendChild(table);
            }
        </script>
    </body>
</html>
