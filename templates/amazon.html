<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Amazon Scraper</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-yellow-50 flex justify-center items-center min-h-screen">
        <div
            class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-[900px] text-center"
        >
            <h1
                class="text-3xl font-bold mb-4 text-yellow-700 flex items-center justify-center gap-2"
            >
                üõçÔ∏è Amazon Scraper
            </h1>
            <p class="text-gray-600 mb-4">
                Paste up to <strong>2000 Amazon product URLs</strong> below ‚Äî
                one per line:
            </p>

            <textarea
                id="urlInput"
                placeholder="https://amazon.com/dp/xxxxxxx"
                class="border border-gray-300 rounded-lg p-3 w-full h-[300px] resize-y focus:ring-2 focus:ring-yellow-500 focus:outline-none text-sm"
            ></textarea>

            <div class="flex gap-3 justify-center mt-4">
                <button
                    id="scrapeBtn"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg shadow"
                >
                    üöÄ Start Scraping
                </button>
                <button
                    id="downloadBtn"
                    class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow hidden"
                >
                    ‚¨áÔ∏è Download CSV
                </button>
                <a
                    href="/"
                    class="inline-flex items-center px-6 py-2 border rounded-lg text-gray-600 hover:bg-gray-50"
                    >‚Üê Home</a
                >
            </div>

            <div id="status" class="mt-4 text-gray-700 font-medium"></div>
            <div id="results" class="mt-6 overflow-x-auto"></div>
        </div>

        <script>
            let latestResults = [];

            document
                .getElementById("scrapeBtn")
                .addEventListener("click", async () => {
                    const urlInput = document.getElementById("urlInput");
                    const status = document.getElementById("status");
                    const resultsDiv = document.getElementById("results");
                    const downloadBtn = document.getElementById("downloadBtn");

                    resultsDiv.innerHTML = "";
                    downloadBtn.classList.add("hidden");
                    status.textContent = "‚è≥ Scraping in progress...";

                    const urls = urlInput.value
                        .split("\n")
                        .map((u) => u.trim())
                        .filter((u) => u.length > 0);

                    if (!urls.length) {
                        alert("Please enter at least one URL.");
                        status.textContent = "";
                        return;
                    }

                    try {
                        const res = await fetch("/scrape-amazon", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ urls }),
                        });

                        const data = await res.json();

                        if (data.status === "success") {
                            const r = data.data;
                            const successfulUrls = r.results.map((x) => x.url);
                            const failedUrls = r.failedUrls || [];

                            // ‚úÖ Mark status for each URL
                            const allResults = [
                                ...r.results.map((x) => ({
                                    ...x,
                                    status: "success",
                                })),
                                ...failedUrls.map((url) => ({
                                    url,
                                    status: "failed",
                                    title: "-",
                                    actualPrice: "-",
                                    discountedPrice: "-",
                                    inStock: "-",
                                    itemNumber: "-",
                                    locationZipCode: "-",
                                })),
                            ];

                            latestResults = allResults;

                            status.innerHTML = `‚úÖ Scraped <strong>${r.successfulScrapes}</strong> of <strong>${r.totalUrls}</strong> successfully.`;
                            renderResults(r.results);

                            if (latestResults.length > 0) {
                                downloadBtn.classList.remove("hidden");
                            }
                        } else {
                            status.innerHTML = `‚ùå Error: ${
                                data.message || "Something went wrong."
                            }`;
                        }
                    } catch (err) {
                        console.error(err);
                        status.textContent = "‚ùå Failed to connect to backend.";
                    }
                });

            // ‚úÖ Updated download logic to include both success and failed
            document
                .getElementById("downloadBtn")
                .addEventListener("click", () => {
                    if (!latestResults.length)
                        return alert("No results to download.");

                    const headers = Object.keys(latestResults[0]);
                    const rows = latestResults.map((obj) =>
                        headers
                            .map((h) => JSON.stringify(obj[h] ?? ""))
                            .join(",")
                    );
                    const csvContent = [headers.join(","), ...rows].join("\n");
                    const blob = new Blob([csvContent], {
                        type: "text/csv;charset=utf-8;",
                    });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = "amazon_results.csv";
                    link.click();
                });

            function renderResults(results) {
                const resultsDiv = document.getElementById("results");
                if (!results || !results.length) {
                    resultsDiv.innerHTML =
                        "<p class='text-gray-500'>No results found.</p>";
                    return;
                }

                const table = document.createElement("table");
                table.className =
                    "w-full border border-gray-300 text-left text-sm";
                table.innerHTML = `
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="border px-3 py-2">ASIN / ID</th>
                            <th class="border px-3 py-2">Title</th>
                            <th class="border px-3 py-2">Actual Price ($)</th>
                            <th class="border px-3 py-2">Discounted ($)</th>
                            <th class="border px-3 py-2">In Stock</th>
                            <th class="border px-3 py-2">Zip</th>
                            <th class="border px-3 py-2">Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results
                            .map(
                                (r) => `
                                <tr class="hover:bg-gray-50">
                                    <td class="border px-3 py-2">${
                                        r.itemNumber || "-"
                                    }</td>
                                    <td class="border px-3 py-2">${
                                        r.title || "-"
                                    }</td>
                                    <td class="border px-3 py-2">${
                                        r.actualPrice ?? "-"
                                    }</td>
                                    <td class="border px-3 py-2">${
                                        r.discountedPrice ?? "-"
                                    }</td>
                                    <td class="border px-3 py-2">${
                                        r.inStock ? "‚úÖ Yes" : "‚ùå No"
                                    }</td>
                                    <td class="border px-3 py-2">${
                                        r.locationZipCode ?? "-"
                                    }</td>
                                    <td class="border px-3 py-2">
                                        <a href="${
                                            r.url
                                        }" target="_blank" class="text-blue-600 hover:underline">Open</a>
                                    </td>
                                </tr>`
                            )
                            .join("")}
                    </tbody>
                `;
                resultsDiv.appendChild(table);
            }
        </script>
    </body>
</html>
