<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Amazon Scraper</title>
        <script src="https://cdn.tailwindcss.com"></script>
    </head>

    <body class="bg-gradient-to-br from-yellow-50 to-yellow-100 flex justify-center items-center min-h-screen">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-3xl text-center">
            <h1 class="text-3xl font-bold mb-4 text-yellow-700">
                üõçÔ∏è Amazon Scraper
            </h1>
            <p class="text-gray-600 mb-6">
                Upload a CSV file with Amazon product URLs and scrape details instantly.
            </p>

            <input
                type="file"
                id="csvFile"
                accept=".csv"
                class="border border-gray-300 rounded-lg p-2 w-full mb-4 focus:ring-2 focus:ring-yellow-500 outline-none"
            />

            <div class="flex gap-2 justify-center">
                <button
                    id="scrapeBtn"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg transition"
                >
                    üöÄ Start Scraping
                </button>
                <a
                    href="/"
                    class="inline-flex items-center px-6 py-2 border rounded-lg text-gray-600 hover:bg-gray-50 transition"
                    >‚Üê Home</a
                >
            </div>

            <div id="status" class="mt-5 text-gray-700 text-sm"></div>

            <div id="results" class="mt-6 overflow-x-auto"></div>
        </div>

        <script>
            document
                .getElementById("scrapeBtn")
                .addEventListener("click", async () => {
                    const fileInput = document.getElementById("csvFile");
                    const status = document.getElementById("status");
                    const resultsDiv = document.getElementById("results");
                    resultsDiv.innerHTML = "";
                    status.textContent = "‚è≥ Scraping in progress...";

                    if (!fileInput.files.length) {
                        alert("Please select a CSV file first.");
                        status.textContent = "";
                        return;
                    }

                    const formData = new FormData();
                    formData.append("file", fileInput.files[0]);

                    try {
                        const res = await fetch("/scrape-amazon", {
                            method: "POST",
                            body: formData,
                        });
                        const data = await res.json();

                        if (data.status === "success" && data.data) {
                            const r = data.data;
                            status.innerHTML = `
                                ‚úÖ <strong>${r.successfulScrapes}</strong> of <strong>${r.totalUrls}</strong> URLs scraped successfully.
                                ${r.failedScrapes > 0 ? `<br>‚ö†Ô∏è Failed URLs: ${r.failedScrapes}` : ""}
                            `;
                            renderResults(r.results);
                        } else {
                            status.innerHTML = `‚ùå Error: ${data.message || "Something went wrong."}`;
                        }
                    } catch (err) {
                        console.error(err);
                        status.textContent = "‚ùå Failed to connect to backend.";
                    }
                });

            function renderResults(results) {
                const resultsDiv = document.getElementById("results");
                if (!results || !results.length) {
                    resultsDiv.innerHTML = "<p>No results found.</p>";
                    return;
                }

                const table = document.createElement("table");
                table.className = "w-full border border-gray-300 text-left text-sm rounded-lg overflow-hidden";
                table.innerHTML = `
                    <thead class="bg-yellow-100 text-yellow-800">
                        <tr>
                            <th class="border px-3 py-2">ASIN / ID</th>
                            <th class="border px-3 py-2">Title</th>
                            <th class="border px-3 py-2">Actual Price</th>
                            <th class="border px-3 py-2">Discounted Price</th>
                            <th class="border px-3 py-2">In Stock</th>
                            <th class="border px-3 py-2">Stock Count</th>
                            <th class="border px-3 py-2">Link</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${results
                            .map(
                                (r) => `
                            <tr class="hover:bg-yellow-50 transition">
                                <td class="border px-3 py-2 font-mono">${r.itemNumber || "-"}</td>
                                <td class="border px-3 py-2">${r.title || "-"}</td>
                                <td class="border px-3 py-2">$${r.actualPrice ?? "-"}</td>
                                <td class="border px-3 py-2">$${r.discountedPrice ?? "-"}</td>
                                <td class="border px-3 py-2">
                                    ${
                                        r.inStock
                                            ? `<span class="text-green-600 font-semibold">‚úÖ Yes</span>`
                                            : `<span class="text-red-600 font-semibold">‚ùå No</span>`
                                    }
                                </td>
                                <td class="border px-3 py-2">${r.numberInStock ?? "-"}</td>
                                <td class="border px-3 py-2">
                                    <a href="${r.url}" target="_blank" class="text-blue-500 hover:underline">Open</a>
                                </td>
                            </tr>
                        `
                            )
                            .join("")}
                    </tbody>
                `;
                resultsDiv.appendChild(table);
            }
        </script>
    </body>
</html>
